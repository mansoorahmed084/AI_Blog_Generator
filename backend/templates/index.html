<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tailwind CSS Template</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Custom CSS for Loading Spinner -->
    <style>
        /* Rotating spinner animation */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .spinner {
            animation: spin 1s linear infinite;
            width: 4rem;
            height: 4rem;
            border: 4px solid #dbeafe;
            border-top-color: #2563eb;
            border-radius: 50%;
        }
        
        /* Fade in/out animation for loading overlay */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        /* Ensure hidden class works */
        .hidden {
            display: none !important;
        }
        
        /* Ensure overlay is on top */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9999;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen bg-gray-100 font-sans antialias">
    <nav class="bg-blue-600 p-4 text-white flex justify-between">
        <div>
            <h1 class="text-3xl font-bold">AI Blog Generator</h1>
        </div> 
        <div class="flex items-center space-x-4">
            {% if user.is_authenticated %}
                <a href="{% url 'all_blog_posts' %}" class="text-white hover:underline">My Blogs</a>
                <span class="text-white">Welcome, {{ user.username }}!</span>
                <a href="{% url 'logout' %}" class="text-white hover:underline">Logout</a>
            {% else %}
                <a href="{% url 'login' %}" class="text-white hover:underline">Login</a>
                <a href="{% url 'signup' %}" class="text-white hover:underline">Sign Up</a>
            {% endif %}
        </div>
    </nav>
    <br> 
    <br>

    <!--Main-->
    <div class="flex-grow container mx-auto mt-10 sm:px-0">
        <div class="max-w-3xl mx-auto bg-white p-6 rounded-lg shadow-md transition-transform transform hover:scale-105 flex flex-col">
            <!--Introduction section-->
            <div class="text-center">
                <h2 class="text-2xl font-semibold mb-4">Welcome to AI Blog Generator</h2>
                <p class="text-gray-700">Generate high quality blog articles from YouTube videos using Artificial Intelligence.
                    Simply enter the video link to YouTube video below and press the button
                </p>
            </div>
        </div>
        <br>
        <!--Youtube link section-->
        <div>
            <h2 class="text-xl mb-4 font-semibold">Enter the YouTube link here</h2>
            {% if messages %}
            <div class="mb-4">
                {% for message in messages %}
                <div class="p-4 mb-2 bg-{% if message.tags == 'error' %}red{% elif message.tags == 'success' %}green{% else %}blue{% endif %}-50 border-l-4 border-{% if message.tags == 'error' %}red{% elif message.tags == 'success' %}green{% else %}blue{% endif %}-500 rounded">
                    <p class="text-sm text-{% if message.tags == 'error' %}red{% elif message.tags == 'success' %}green{% else %}blue{% endif %}-800">{{ message }}</p>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            <form id="blogGenerationForm" method="POST" action="{% url 'generate_blog' %}">
                {% csrf_token %}
                <div class="flex space-x-4 mb-3">
                    <input 
                        id="youtubelink" 
                        name="youtube_url"
                        type="url" 
                        placeholder="Paste Youtube link..." 
                        required
                        class="flex-grow p-2 border border-blue-400 rounded-l-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                    <button 
                        type="submit"
                        id="generateBlogButton" 
                        class="bg-blue-600 text-white px-4 py-2 rounded-r-md hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        Generate Blog
                    </button>
                </div>
                
                <!-- Advanced Options Toggle -->
                <div class="mb-3">
                    <button 
                        type="button"
                        id="advancedToggle"
                        class="text-sm text-blue-600 hover:text-blue-800 hover:underline flex items-center"
                    >
                        <span id="advancedToggleIcon" class="mr-1">▶</span>
                        <span>Advanced Options</span>
                    </button>
                </div>
                
                <!-- Advanced Options Panel (Hidden by default) -->
                <div id="advancedOptions" class="hidden bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
                    <div class="space-y-3">
                        <div class="flex items-center">
                            <input 
                                type="checkbox" 
                                id="useAudioDownload"
                                name="use_audio_download"
                                class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                            >
                            <label for="useAudioDownload" class="ml-2 text-sm text-gray-700">
                                Download audio/video if transcript is unavailable
                            </label>
                        </div>
                        <p class="text-xs text-gray-500 ml-6">
                            By default, we use YouTube's built-in transcripts (fastest). Enable this to download and transcribe audio when transcripts aren't available.
                        </p>
                    </div>
                </div>
            </form>
        </div>

        <!--Generted blog display section-->
        <section class="mt-10 flex-grow">
            <h2 class="text-xl mb-4  font-semibold">Generated blog article</h2>
            <div id="blogContent" class="mt-2 text-gray-700 space-y-4">
                <!--Section for loading circle-->
            </div>
        </section>
    </div>

    <footer class="text-center p-4 text-black mt-6">
        <p class="text-sm text-gray-600 font-medium mb-2">Powered by:</p>
        <div class="flex flex-wrap justify-center gap-2 text-xs text-gray-500">
            <span class="px-2 py-1 bg-blue-50 rounded">Django</span>
            <span class="px-2 py-1 bg-green-50 rounded">Groq</span>
            <span class="px-2 py-1 bg-purple-50 rounded">Gemini</span>
            <span class="px-2 py-1 bg-orange-50 rounded">AssemblyAI</span>
            <span class="px-2 py-1 bg-red-50 rounded">YouTube API</span>
            <span class="px-2 py-1 bg-yellow-50 rounded">yt-dlp</span>
            <span class="px-2 py-1 bg-indigo-50 rounded">Playwright</span>
            <span class="px-2 py-1 bg-pink-50 rounded">Whisper</span>
            <span class="px-2 py-1 bg-teal-50 rounded">Tailwind CSS</span>
        </div>
    </footer>

    <!-- Loading Spinner Overlay - MUST be outside main content for fixed positioning -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 fade-in">
        <div class="bg-white rounded-lg p-8 flex flex-col items-center shadow-xl">
            <!-- Rotating Circle Spinner -->
            <div class="spinner w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full mb-4"></div>
            <p class="text-gray-700 text-lg font-semibold">Processing...</p>
            <p class="text-gray-500 text-sm mt-2">Transcribing video and generating text</p>
        </div>
    </div>

    <!-- JavaScript to show/hide spinner -->
    <script>
        // Function to show loading spinner
        function showLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.classList.remove('hidden');
            }
        }
        
        // Function to hide loading spinner
        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.classList.add('hidden');
            }
        }
        
        // Handle Advanced Options Toggle
        document.addEventListener('DOMContentLoaded', function() {
            const advancedToggle = document.getElementById('advancedToggle');
            const advancedOptions = document.getElementById('advancedOptions');
            const advancedToggleIcon = document.getElementById('advancedToggleIcon');
            
            if (advancedToggle && advancedOptions) {
                advancedToggle.addEventListener('click', function() {
                    const isHidden = advancedOptions.classList.contains('hidden');
                    if (isHidden) {
                        advancedOptions.classList.remove('hidden');
                        advancedToggleIcon.textContent = '▼';
                    } else {
                        advancedOptions.classList.add('hidden');
                        advancedToggleIcon.textContent = '▶';
                    }
                });
            }
        });
        
        // Handle blog generation form submission
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('blogGenerationForm');
            const generateButton = document.getElementById('generateBlogButton');
            const youtubeInput = document.getElementById('youtubelink');
            
            if (form) {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const youtubeUrl = youtubeInput.value.trim();
                    
                    if (!youtubeUrl) {
                        alert('Please enter a YouTube URL');
                        return;
                    }
                    
                    // Validate YouTube URL
                    if (!youtubeUrl.includes('youtube.com') && !youtubeUrl.includes('youtu.be')) {
                        alert('Please enter a valid YouTube URL');
                        return;
                    }
                    
                    // Show loading state
                    showLoading();
                    generateButton.disabled = true;
                    generateButton.textContent = 'Generating...';
                    
                    // Get CSRF token
                    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                    
                    let timeoutId = null;
                    try {
                        // Submit form via AJAX
                        const formData = new FormData(form);
                        const generateUrl = '{% url "generate_blog" %}';
                        
                        console.log('Sending request to:', generateUrl);
                        console.log('YouTube URL:', youtubeUrl);
                        
                        // Create AbortController for timeout
                        const controller = new AbortController();
                        timeoutId = setTimeout(() => controller.abort(), 600000); // 10 minute timeout
                        
                        const response = await fetch(generateUrl, {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'X-CSRFToken': csrftoken
                            },
                            signal: controller.signal
                        });
                        
                        if (timeoutId) clearTimeout(timeoutId);
                        
                        console.log('Response status:', response.status);
                        
                        // Check if response is JSON or HTML (redirect)
                        const contentType = response.headers.get('content-type');
                        if (!contentType || !contentType.includes('application/json')) {
                            // Got HTML instead of JSON - likely a redirect to login
                            hideLoading();
                            generateButton.disabled = false;
                            generateButton.textContent = 'Generate Blog';
                            alert('Please log in to generate blog posts. Redirecting to login page...');
                            window.location.href = '/login/?next=/generate-blog/';
                            return;
                        }
                        
                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error('Error response:', errorText);
                            // Try to parse as JSON
                            try {
                                const errorData = JSON.parse(errorText);
                                if (errorData.login_required) {
                                    hideLoading();
                                    generateButton.disabled = false;
                                    generateButton.textContent = 'Generate Blog';
                                    alert('Please log in to generate blog posts. Redirecting to login page...');
                                    window.location.href = errorData.login_url || '/login/';
                                    return;
                                }
                                throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                            } catch {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                        }
                        
                        const data = await response.json();
                        console.log('Response data:', data);
                        
                        if (data.success) {
                            // Success - redirect to blog details page
                            window.location.href = data.redirect_url;
                        } else {
                            // Check if bot detection error
                            if (data.bot_detection) {
                                hideLoading();
                                generateButton.disabled = false;
                                generateButton.textContent = 'Generate Blog';
                                // CAPTCHA handling removed - using transcript API only
                            } else {
                                // Other error - show message
                                hideLoading();
                                generateButton.disabled = false;
                                generateButton.textContent = 'Generate Blog';
                                if (data.login_required) {
                                    alert('Please log in to generate blog posts. Redirecting to login page...');
                                    window.location.href = data.login_url || '/login/';
                                } else {
                                    alert('Error: ' + (data.error || 'Failed to generate blog post'));
                                }
                            }
                        }
                    } catch (error) {
                        if (timeoutId) clearTimeout(timeoutId);
                        // Network or other error
                        hideLoading();
                        generateButton.disabled = false;
                        generateButton.textContent = 'Generate Blog';
                        
                        let errorMessage = 'Unknown error occurred';
                        if (error.name === 'AbortError') {
                            errorMessage = 'Request timed out. Blog generation takes several minutes. Please check if it completed in the background.';
                        } else if (error.message) {
                            errorMessage = error.message;
                        }
                        
                        alert('Error: ' + errorMessage);
                        console.error('Full error:', error);
                        console.error('Error details:', {
                            name: error.name,
                            message: error.message,
                            stack: error.stack
                        });
                    }
                });
            }
        });
        
        // CAPTCHA handling removed - using transcript API only
    </script>

</body>
</html>